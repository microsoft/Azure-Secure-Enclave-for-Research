{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.4.1318.3566",
      "templateHash": "8902790217779301758"
    }
  },
  "parameters": {
    "deploymentTime": {
      "type": "string",
      "defaultValue": "[utcNow()]"
    },
    "location": {
      "type": "string",
      "defaultValue": "[deployment().location]"
    },
    "environment": {
      "type": "string",
      "allowedValues": [
        "dev",
        "test",
        "prod",
        "sandbox",
        "staging",
        "shared",
        "uat"
      ]
    },
    "workspaceName": {
      "type": "string"
    },
    "approverEmail": {
      "type": "string"
    },
    "sequence": {
      "type": "int",
      "defaultValue": 1
    },
    "tags": {
      "type": "object",
      "defaultValue": {}
    },
    "avdAccess": {
      "type": "bool",
      "defaultValue": false
    },
    "rdshVmSize": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3"
    },
    "vmCount": {
      "type": "int",
      "defaultValue": 1
    },
    "virtualNetwork": {
      "type": "object",
      "defaultValue": {}
    },
    "hubVirtualNetworkId": {
      "type": "string",
      "defaultValue": ""
    },
    "defaultRouteNextHop": {
      "type": "string",
      "defaultValue": ""
    },
    "computeSubnetId": {
      "type": "string",
      "defaultValue": ""
    },
    "privateEndpointSubnetId": {
      "type": "string",
      "defaultValue": ""
    },
    "privateStorage": {
      "type": "object",
      "defaultValue": {}
    },
    "logAnalytics": {
      "type": "object",
      "defaultValue": {}
    },
    "userAssignedManagedIdentity": {
      "type": "object",
      "defaultValue": {}
    },
    "pipelineName": {
      "type": "string",
      "defaultValue": "pipe-data_move"
    }
  },
  "variables": {
    "namingConvention": "{wloadname}-{subwloadname}-{rtype}-{env}-{loc}-{seq}",
    "sequenceFormatted": "[format('{0:00}', parameters('sequence'))]",
    "deploymentNameStructure": "[toLower(format('{0}-{{rtype}}-{1}', parameters('workspaceName'), parameters('deploymentTime')))]",
    "namingStructure": "[toLower(replace(replace(replace(replace(variables('namingConvention'), '{env}', parameters('environment')), '{loc}', parameters('location')), '{seq}', variables('sequenceFormatted')), '{wloadname}', parameters('workspaceName')))]",
    "containerNames": {
      "exportApprovedContainerName": "export-approved",
      "ingestContainerName": "ingest",
      "exportPendingContainerName": "export-pending"
    },
    "vnetAddressPrefixes": [
      "172.17.0.0/24"
    ],
    "subnets": {
      "privateEndpoints": {
        "name": "privateEndpoints",
        "addressPrefix": "172.17.0.0/25",
        "privateEndpointNetworkPolicies": "Enabled",
        "serviceEndpoints": []
      },
      "workload": {
        "name": "compute",
        "addressPrefix": "172.17.0.128/25",
        "privateEndpointNetworkPolicies": "Disabled",
        "serviceEndpoints": []
      }
    }
  },
  "resources": [
    {
      "condition": "[empty(parameters('logAnalytics'))]",
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[replace(replace(variables('namingStructure'), '{subwloadname}', 'sharedsvc'), '{rtype}', 'rg')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags').All_Resources]"
    },
    {
      "condition": "[empty(parameters('virtualNetwork'))]",
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[replace(replace(variables('namingStructure'), '{subwloadname}', 'network'), '{rtype}', 'rg')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags').All_Resources]"
    },
    {
      "condition": "[empty(parameters('privateStorage'))]",
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[replace(replace(variables('namingStructure'), '{subwloadname}', 'storage'), '{rtype}', 'rg')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags').All_Resources]"
    },
    {
      "condition": "[empty(parameters('logAnalytics'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[replace(variables('deploymentNameStructure'), '{rtype}', 'law')]",
      "resourceGroup": "[replace(replace(variables('namingStructure'), '{subwloadname}', 'sharedsvc'), '{rtype}', 'rg')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "namingStructure": {
            "value": "[variables('namingStructure')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags').All_Resources]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1318.3566",
              "templateHash": "9465307325437266794"
            }
          },
          "parameters": {
            "namingStructure": {
              "type": "string"
            },
            "subwloadname": {
              "type": "string",
              "defaultValue": ""
            },
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "variables": {
            "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2020-03-01-preview",
              "name": "[replace(variables('baseName'), '{rtype}', 'law')]",
              "location": "[parameters('location')]",
              "properties": {
                "retentionInDays": 30,
                "features": {
                  "searchVersion": 1
                },
                "sku": {
                  "name": "PerGB2018"
                }
              },
              "tags": "[parameters('tags')]"
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', replace(replace(variables('namingStructure'), '{subwloadname}', 'sharedsvc'), '{rtype}', 'rg'))]"
      ]
    },
    {
      "condition": "[empty(parameters('virtualNetwork'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[replace(variables('deploymentNameStructure'), '{rtype}', 'net')]",
      "resourceGroup": "[replace(replace(variables('namingStructure'), '{subwloadname}', 'network'), '{rtype}', 'rg')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "namingStructure": {
            "value": "[variables('namingStructure')]"
          },
          "addressPrefixes": {
            "value": "[variables('vnetAddressPrefixes')]"
          },
          "subnets": {
            "value": "[variables('subnets')]"
          },
          "defaultRouteNextHop": {
            "value": "[parameters('defaultRouteNextHop')]"
          },
          "hubVirtualNetworkId": {
            "value": "[parameters('hubVirtualNetworkId')]"
          },
          "tags": {
            "value": "[parameters('tags').All_Resources]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1318.3566",
              "templateHash": "13030508223364887326"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "namingStructure": {
              "type": "string"
            },
            "subwloadname": {
              "type": "string",
              "defaultValue": ""
            },
            "addressPrefixes": {
              "type": "array"
            },
            "dnsServers": {
              "type": "array",
              "defaultValue": []
            },
            "subnets": {
              "type": "object"
            },
            "nsgSecurityRules": {
              "type": "array",
              "defaultValue": []
            },
            "defaultRouteNextHop": {
              "type": "string",
              "defaultValue": ""
            },
            "hubVirtualNetworkId": {
              "type": "string",
              "defaultValue": ""
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "variables": {
            "customDNS": "[not(empty(parameters('dnsServers')))]",
            "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2021-05-01",
              "name": "[replace(variables('baseName'), '{rtype}', 'vnet')]",
              "location": "[parameters('location')]",
              "properties": {
                "copy": [
                  {
                    "name": "subnets",
                    "count": "[length(items(parameters('subnets')))]",
                    "input": {
                      "name": "[items(parameters('subnets'))[copyIndex('subnets')].value.name]",
                      "properties": {
                        "addressPrefix": "[items(parameters('subnets'))[copyIndex('subnets')].value.addressPrefix]",
                        "privateEndpointNetworkPolicies": "[if(not(empty(items(parameters('subnets'))[copyIndex('subnets')].value.privateEndpointNetworkPolicies)), 'Disabled', items(parameters('subnets'))[copyIndex('subnets')].value.privateEndpointNetworkPolicies)]",
                        "networkSecurityGroup": {
                          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', format('nsg-{0}', items(parameters('subnets'))[copyIndex('subnets')].value.name))]"
                        },
                        "routeTable": {
                          "id": "[resourceId('Microsoft.Network/routeTables', format('rt-{0}', items(parameters('subnets'))[copyIndex('subnets')].value.name))]"
                        }
                      }
                    }
                  }
                ],
                "addressSpace": {
                  "addressPrefixes": "[parameters('addressPrefixes')]"
                },
                "dhcpOptions": "[if(variables('customDNS'), createObject('dnsServers', parameters('dnsServers')), json('null'))]"
              },
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "networkSecurityGroups",
                "routeTables"
              ]
            },
            {
              "copy": {
                "name": "networkSecurityGroups",
                "count": "[length(items(parameters('subnets')))]"
              },
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2021-05-01",
              "name": "[format('nsg-{0}', items(parameters('subnets'))[copyIndex()].value.name)]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": "[if(not(empty(parameters('nsgSecurityRules'))), parameters('nsgSecurityRules'), json('null'))]"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "copy": {
                "name": "routeTables",
                "count": "[length(items(parameters('subnets')))]"
              },
              "type": "Microsoft.Network/routeTables",
              "apiVersion": "2021-05-01",
              "name": "[format('rt-{0}', items(parameters('subnets'))[copyIndex()].value.name)]",
              "location": "[parameters('location')]",
              "properties": {
                "disableBgpRoutePropagation": true,
                "routes": "[if(not(empty(parameters('defaultRouteNextHop'))), createArray(createObject('name', 'default', 'properties', createObject('addressPrefix', '0.0.0.0/0', 'nextHopIpAddress', parameters('defaultRouteNextHop'), 'nextHopType', 'VirtualAppliance'))), json('null'))]"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[not(empty(parameters('hubVirtualNetworkId')))]",
              "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
              "apiVersion": "2021-05-01",
              "name": "[format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'vnet'), format('{0}-to-{1}', replace(variables('baseName'), '{rtype}', 'vnet'), last(split(parameters('hubVirtualNetworkId'), '/'))))]",
              "properties": {
                "allowForwardedTraffic": true,
                "allowGatewayTransit": false,
                "allowVirtualNetworkAccess": true,
                "remoteVirtualNetwork": {
                  "id": "[parameters('hubVirtualNetworkId')]"
                },
                "useRemoteGateways": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', replace(variables('baseName'), '{rtype}', 'vnet'))]"
              ]
            }
          ],
          "outputs": {
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', replace(variables('baseName'), '{rtype}', 'vnet'))]"
            },
            "pepSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'vnet'), parameters('subnets').privateEndpoints.name), '/')[0], split(format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'vnet'), parameters('subnets').privateEndpoints.name), '/')[1])]"
            },
            "workloadSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'vnet'), parameters('subnets').workload.name), '/')[0], split(format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'vnet'), parameters('subnets').workload.name), '/')[1])]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', replace(replace(variables('namingStructure'), '{subwloadname}', 'network'), '{rtype}', 'rg'))]"
      ]
    },
    {
      "condition": "[empty(parameters('virtualNetwork'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[replace(variables('deploymentNameStructure'), '{rtype}', 'networkWatcherRG')]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags').All_Resources]"
          },
          "deploymentNameStructure": {
            "value": "[variables('deploymentNameStructure')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1318.3566",
              "templateHash": "13888710217057308210"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "deploymentNameStructure": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "NetworkWatcherRG",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'networkWatcher')]",
              "resourceGroup": "NetworkWatcherRG",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "10653954262655106968"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkWatchers",
                      "apiVersion": "2021-05-01",
                      "name": "[format('NetworkWatcher_{0}', parameters('location'))]",
                      "location": "[parameters('location')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', 'NetworkWatcherRG')]"
              ]
            }
          ]
        }
      }
    },
    {
      "condition": "[empty(parameters('privateStorage'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[replace(variables('deploymentNameStructure'), '{rtype}', 'stg-pri')]",
      "resourceGroup": "[replace(replace(variables('namingStructure'), '{subwloadname}', 'storage'), '{rtype}', 'rg')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "namingStructure": {
            "value": "[variables('namingStructure')]"
          },
          "subwloadname": {
            "value": "pri"
          },
          "containerNames": {
            "value": [
              "[variables('containerNames').exportApprovedContainerName]",
              "[variables('containerNames').exportPendingContainerName]"
            ]
          },
          "vnetId": {
            "value": "[if(empty(parameters('virtualNetwork')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(replace(variables('namingStructure'), '{subwloadname}', 'network'), '{rtype}', 'rg')), 'Microsoft.Resources/deployments', replace(variables('deploymentNameStructure'), '{rtype}', 'net')), '2020-10-01').outputs.vnetId.value, parameters('virtualNetwork').id)]"
          },
          "subnetId": {
            "value": "[if(empty(parameters('virtualNetwork')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(replace(variables('namingStructure'), '{subwloadname}', 'network'), '{rtype}', 'rg')), 'Microsoft.Resources/deployments', replace(variables('deploymentNameStructure'), '{rtype}', 'net')), '2020-10-01').outputs.pepSubnetId.value, parameters('privateEndpointSubnetId'))]"
          },
          "privatize": {
            "value": true
          },
          "tags": {
            "value": "[parameters('tags').All_Resources]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1318.3566",
              "templateHash": "14962272343539166207"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "namingStructure": {
              "type": "string"
            },
            "subwloadname": {
              "type": "string"
            },
            "containerNames": {
              "type": "array"
            },
            "skuName": {
              "type": "string",
              "defaultValue": "Standard_LRS"
            },
            "privatize": {
              "type": "bool",
              "defaultValue": false
            },
            "vnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "subnetId": {
              "type": "string",
              "defaultValue": ""
            },
            "principalIds": {
              "type": "array",
              "defaultValue": []
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "variables": {
            "assignRole": "[not(empty(parameters('principalIds')))]",
            "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]",
            "stgNameClean": "[take(replace(guid(subscription().id, resourceGroup().id, variables('baseName')), '-', ''), 22)]",
            "endpoint": "[format('privatelink.blob.{0}', environment().suffixes.storage)]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-06-01",
              "name": "[format('st{0}', variables('stgNameClean'))]",
              "location": "[parameters('location')]",
              "kind": "StorageV2",
              "sku": {
                "name": "[parameters('skuName')]"
              },
              "properties": {
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "isHnsEnabled": true,
                "supportsHttpsTrafficOnly": true,
                "accessTier": "Hot",
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "[if(parameters('privatize'), 'Deny', 'Allow')]"
                },
                "publicNetworkAccess": "[if(parameters('privatize'), 'Disabled', 'Enabled')]"
              },
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', format('st{0}', variables('stgNameClean')), 'default')]",
              "properties": {
                "containerDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                },
                "deleteRetentionPolicy": {
                  "enabled": false
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', format('st{0}', variables('stgNameClean')))]"
              ]
            },
            {
              "copy": {
                "name": "container",
                "count": "[length(parameters('containerNames'))]"
              },
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}/{2}', format('st{0}', variables('stgNameClean')), 'default', parameters('containerNames')[copyIndex()])]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', format('st{0}', variables('stgNameClean')), 'default')]",
                "[resourceId('Microsoft.Storage/storageAccounts', format('st{0}', variables('stgNameClean')))]"
              ]
            },
            {
              "condition": "[parameters('privatize')]",
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2021-03-01",
              "name": "[replace(variables('baseName'), '{rtype}', 'pep')]",
              "location": "[parameters('location')]",
              "tags": {},
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetId')]"
                },
                "privateLinkServiceConnections": [
                  {
                    "name": "[replace(variables('baseName'), '{rtype}', 'pep')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', format('st{0}', variables('stgNameClean')))]",
                      "groupIds": [
                        "blob"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', format('st{0}', variables('stgNameClean')))]"
              ]
            },
            {
              "condition": "[parameters('privatize')]",
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2018-09-01",
              "name": "[variables('endpoint')]",
              "location": "global",
              "properties": {},
              "tags": "[parameters('tags')]"
            },
            {
              "condition": "[parameters('privatize')]",
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}/default', replace(variables('baseName'), '{rtype}', 'pep'))]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "privatelink-blob-core-windows-net",
                    "properties": {
                      "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('endpoint'))]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', replace(variables('baseName'), '{rtype}', 'pep'))]",
                "[resourceId('Microsoft.Network/privateDnsZones', variables('endpoint'))]"
              ]
            },
            {
              "condition": "[parameters('privatize')]",
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2018-09-01",
              "name": "[format('{0}/{1}', variables('endpoint'), uniqueString(parameters('vnetId')))]",
              "location": "global",
              "properties": {
                "virtualNetwork": {
                  "id": "[parameters('vnetId')]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('endpoint'))]"
              ]
            },
            {
              "condition": "[variables('assignRole')]",
              "copy": {
                "name": "rbacAssignment",
                "count": "[length(parameters('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-10-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', format('st{0}', variables('stgNameClean')))]",
              "name": "[guid(format('rbac-{0}-{1}', format('st{0}', variables('stgNameClean')), parameters('principalIds')[copyIndex()]))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                "principalId": "[parameters('principalIds')[copyIndex()]]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', format('st{0}', variables('stgNameClean')))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', format('st{0}', variables('stgNameClean')))]"
            },
            "storageAccountName": {
              "type": "string",
              "value": "[format('st{0}', variables('stgNameClean'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', replace(replace(variables('namingStructure'), '{subwloadname}', 'storage'), '{rtype}', 'rg'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(replace(variables('namingStructure'), '{subwloadname}', 'network'), '{rtype}', 'rg')), 'Microsoft.Resources/deployments', replace(variables('deploymentNameStructure'), '{rtype}', 'net'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('data-automation-{0}', parameters('deploymentTime'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "workspaceName": {
            "value": "[parameters('workspaceName')]"
          },
          "namingStructure": {
            "value": "[variables('namingStructure')]"
          },
          "deploymentNameStructure": {
            "value": "[variables('deploymentNameStructure')]"
          },
          "containerNames": {
            "value": "[variables('containerNames')]"
          },
          "pipelineName": {
            "value": "[parameters('pipelineName')]"
          },
          "privateStorageAccountName": {
            "value": "[if(empty(parameters('privateStorage')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(replace(variables('namingStructure'), '{subwloadname}', 'storage'), '{rtype}', 'rg')), 'Microsoft.Resources/deployments', replace(variables('deploymentNameStructure'), '{rtype}', 'stg-pri')), '2020-10-01').outputs.storageAccountName.value, parameters('privateStorage').name)]"
          },
          "privateStorageAccountRG": {
            "value": "[if(empty(parameters('privateStorage')), replace(replace(variables('namingStructure'), '{subwloadname}', 'storage'), '{rtype}', 'rg'), split(parameters('privateStorage').id, '/')[3])]"
          },
          "approverEmail": {
            "value": "[parameters('approverEmail')]"
          },
          "userAssignedManagedIdentity": {
            "value": "[parameters('userAssignedManagedIdentity')]"
          },
          "tags": {
            "value": "[parameters('tags').All_Resources]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1318.3566",
              "templateHash": "8236807816725951653"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "namingStructure": {
              "type": "string"
            },
            "workspaceName": {
              "type": "string"
            },
            "deploymentNameStructure": {
              "type": "string"
            },
            "privateStorageAccountName": {
              "type": "string"
            },
            "privateStorageAccountRG": {
              "type": "string"
            },
            "containerNames": {
              "type": "object"
            },
            "approverEmail": {
              "type": "string"
            },
            "pipelineName": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "userAssignedManagedIdentity": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "variables": {
            "uamiRoles": {
              "Storage Account Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]",
              "Data Factory Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '673868aa-7521-48a0-acc6-0f60742d39f5')]"
            }
          },
          "resources": [
            {
              "condition": "[empty(parameters('userAssignedManagedIdentity'))]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'uami')]",
              "resourceGroup": "[parameters('privateStorageAccountRG')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "namingStructure": {
                    "value": "[parameters('namingStructure')]"
                  },
                  "subwloadname": {
                    "value": "[parameters('workspaceName')]"
                  },
                  "roles": {
                    "value": "[variables('uamiRoles')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "17902204849065772983"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "namingStructure": {
                      "type": "string"
                    },
                    "subwloadname": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "roles": {
                      "type": "object"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                      "apiVersion": "2018-11-30",
                      "name": "[replace(variables('baseName'), '{rtype}', 'uami')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "copy": {
                        "name": "roleAssignment",
                        "count": "[length(items(parameters('roles')))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-10-01-preview",
                      "name": "[guid(format('rbac-{0}-{1}', replace(variables('baseName'), '{rtype}', 'uami'), items(parameters('roles'))[copyIndex()].key))]",
                      "properties": {
                        "roleDefinitionId": "[items(parameters('roles'))[copyIndex()].value]",
                        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', replace(variables('baseName'), '{rtype}', 'uami'))).principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', replace(variables('baseName'), '{rtype}', 'uami'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "managedIdentityId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', replace(variables('baseName'), '{rtype}', 'uami'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'adf')]",
              "resourceGroup": "[parameters('privateStorageAccountRG')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "namingStructure": {
                    "value": "[parameters('namingStructure')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "deploymentNameStructure": {
                    "value": "[parameters('deploymentNameStructure')]"
                  },
                  "privateStorageAcctName": {
                    "value": "[parameters('privateStorageAccountName')]"
                  },
                  "pipelineName": {
                    "value": "[parameters('pipelineName')]"
                  },
                  "userAssignedIdentityId": {
                    "value": "[if(not(empty(parameters('userAssignedManagedIdentity'))), parameters('userAssignedManagedIdentity').id, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'uami')), '2020-10-01').outputs.managedIdentityId.value)]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "8627333561520133072"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "namingStructure": {
                      "type": "string"
                    },
                    "deploymentNameStructure": {
                      "type": "string"
                    },
                    "subwloadname": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "pipelineName": {
                      "type": "string"
                    },
                    "privateStorageAcctName": {
                      "type": "string"
                    },
                    "userAssignedIdentityId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]",
                    "managedVnetName": "default",
                    "autoResolveIntegrationRuntimeName": "AutoResolveIntegrationRuntime",
                    "linkedServiceName": "ls_ADLSGen2_Generic"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.DataFactory/factories",
                      "apiVersion": "2018-06-01",
                      "name": "[replace(variables('baseName'), '{rtype}', 'adf')]",
                      "location": "[parameters('location')]",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.DataFactory/factories/managedVirtualNetworks",
                      "apiVersion": "2018-06-01",
                      "name": "[format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'adf'), variables('managedVnetName'))]",
                      "properties": {},
                      "dependsOn": [
                        "[resourceId('Microsoft.DataFactory/factories', replace(variables('baseName'), '{rtype}', 'adf'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.DataFactory/factories/integrationRuntimes",
                      "apiVersion": "2018-06-01",
                      "name": "[format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'adf'), variables('autoResolveIntegrationRuntimeName'))]",
                      "properties": {
                        "type": "Managed",
                        "managedVirtualNetwork": {
                          "type": "ManagedVirtualNetworkReference",
                          "referenceName": "[variables('managedVnetName')]"
                        },
                        "typeProperties": {
                          "computeProperties": {
                            "location": "AutoResolve"
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DataFactory/factories', replace(variables('baseName'), '{rtype}', 'adf'))]",
                        "[resourceId('Microsoft.DataFactory/factories/managedVirtualNetworks', split(format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'adf'), variables('managedVnetName')), '/')[0], split(format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'adf'), variables('managedVnetName')), '/')[1])]"
                      ]
                    },
                    {
                      "type": "Microsoft.DataFactory/factories/linkedservices",
                      "apiVersion": "2018-06-01",
                      "name": "[format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'adf'), variables('linkedServiceName'))]",
                      "properties": {
                        "type": "AzureBlobFS",
                        "typeProperties": {
                          "url": "[format('@{{concat(''https://'', linkedService().storageAccountName, ''.dfs.{0}'')}}', environment().suffixes.storage)]"
                        },
                        "connectVia": {
                          "referenceName": "[variables('autoResolveIntegrationRuntimeName')]",
                          "type": "IntegrationRuntimeReference"
                        },
                        "parameters": {
                          "storageAccountName": {
                            "type": "String"
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DataFactory/factories', replace(variables('baseName'), '{rtype}', 'adf'))]",
                        "[resourceId('Microsoft.DataFactory/factories/integrationRuntimes', split(format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'adf'), variables('autoResolveIntegrationRuntimeName')), '/')[0], split(format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'adf'), variables('autoResolveIntegrationRuntimeName')), '/')[1])]"
                      ]
                    },
                    {
                      "type": "Microsoft.DataFactory/factories/datasets",
                      "apiVersion": "2018-06-01",
                      "name": "[format('{0}/DfsDataset', replace(variables('baseName'), '{rtype}', 'adf'))]",
                      "properties": {
                        "type": "Binary",
                        "linkedServiceName": {
                          "referenceName": "[variables('linkedServiceName')]",
                          "type": "LinkedServiceReference",
                          "parameters": {
                            "storageAccountName": {
                              "value": "@dataset().storageAccountName",
                              "type": "Expression"
                            }
                          }
                        },
                        "parameters": {
                          "storageAccountName": {
                            "type": "String"
                          },
                          "folderPath": {
                            "type": "String"
                          },
                          "fileName": {
                            "type": "String"
                          }
                        },
                        "typeProperties": {
                          "location": {
                            "type": "AzureBlobFSLocation",
                            "fileName": {
                              "value": "@dataset().fileName",
                              "type": "Expression"
                            },
                            "fileSystem": {
                              "value": "@dataset().folderPath",
                              "type": "Expression"
                            }
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DataFactory/factories', replace(variables('baseName'), '{rtype}', 'adf'))]",
                        "[resourceId('Microsoft.DataFactory/factories/linkedservices', split(format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'adf'), variables('linkedServiceName')), '/')[0], split(format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'adf'), variables('linkedServiceName')), '/')[1])]"
                      ]
                    },
                    {
                      "type": "Microsoft.DataFactory/factories/pipelines",
                      "apiVersion": "2018-06-01",
                      "name": "[format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'adf'), parameters('pipelineName'))]",
                      "properties": {
                        "activities": [
                          "[json('{\r\n\t\"name\": \"Move Data\",\r\n\t\"type\": \"Copy\",\r\n\t\"dependsOn\": [],\r\n\t\"policy\": {\r\n\t\t\"timeout\": \"7.00:00:00\",\r\n\t\t\"retry\": 0,\r\n\t\t\"retryIntervalInSeconds\": 30,\r\n\t\t\"secureOutput\": false,\r\n\t\t\"secureInput\": false\r\n\t},\r\n\t\"userProperties\": [],\r\n\t\"typeProperties\": {\r\n\t\t\"source\": {\r\n\t\t\t\"type\": \"BinarySource\",\r\n\t\t\t\"storeSettings\": {\r\n\t\t\t\t\"type\": \"AzureBlobFSReadSettings\",\r\n\t\t\t\t\"recursive\": true,\r\n\t\t\t\t\"deleteFilesAfterCompletion\": true\r\n\t\t\t},\r\n\t\t\t\"formatSettings\": {\r\n\t\t\t\t\"type\": \"BinaryReadSettings\"\r\n\t\t\t}\r\n\t\t},\r\n\t\t\"sink\": {\r\n\t\t\t\"type\": \"BinarySink\",\r\n\t\t\t\"storeSettings\": {\r\n\t\t\t\t\"type\": \"AzureBlobFSWriteSettings\"\r\n\t\t\t}\r\n\t\t},\r\n\t\t\"enableStaging\": false\r\n\t},\r\n\t\"inputs\": [\r\n\t\t{\r\n\t\t\t\"referenceName\": \"DfsDataset\",\r\n\t\t\t\"type\": \"DatasetReference\",\r\n\t\t\t\"parameters\": {\r\n\t\t\t\t\"storageAccountName\": {\r\n\t\t\t\t\t\"value\": \"@pipeline().parameters.sourceStorageAccountName\",\r\n\t\t\t\t\t\"type\": \"Expression\"\r\n\t\t\t\t},\r\n\t\t\t\t\"folderPath\": {\r\n\t\t\t\t\t\"value\": \"@pipeline().parameters.sourceFolderPath\",\r\n\t\t\t\t\t\"type\": \"Expression\"\r\n\t\t\t\t},\r\n\t\t\t\t\"fileName\": {\r\n\t\t\t\t\t\"value\": \"@pipeline().parameters.fileName\",\r\n\t\t\t\t\t\"type\": \"Expression\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t],\r\n\t\"outputs\": [\r\n\t\t{\r\n\t\t\t\"referenceName\": \"DfsDataset\",\r\n\t\t\t\"type\": \"DatasetReference\",\r\n\t\t\t\"parameters\": {\r\n\t\t\t\t\"storageAccountName\": {\r\n\t\t\t\t\t\"value\": \"@pipeline().parameters.sinkStorageAccountName\",\r\n\t\t\t\t\t\"type\": \"Expression\"\r\n\t\t\t\t},\r\n\t\t\t\t\"folderPath\": {\r\n\t\t\t\t\t\"value\": \"@pipeline().parameters.sinkFolderPath\",\r\n\t\t\t\t\t\"type\": \"Expression\"\r\n\t\t\t\t},\r\n\t\t\t\t\"fileName\": {\r\n\t\t\t\t\t\"value\": \"@pipeline().parameters.fileName\",\r\n\t\t\t\t\t\"type\": \"Expression\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t]\r\n}')]"
                        ],
                        "parameters": {
                          "sourceStorageAccountName": {
                            "type": "String"
                          },
                          "sinkStorageAccountName": {
                            "type": "String"
                          },
                          "sourceFolderPath": {
                            "type": "String"
                          },
                          "sinkFolderPath": {
                            "type": "String"
                          },
                          "fileName": {
                            "type": "String"
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DataFactory/factories', replace(variables('baseName'), '{rtype}', 'adf'))]",
                        "[resourceId('Microsoft.DataFactory/factories/datasets', split(format('{0}/DfsDataset', replace(variables('baseName'), '{rtype}', 'adf')), '/')[0], split(format('{0}/DfsDataset', replace(variables('baseName'), '{rtype}', 'adf')), '/')[1])]"
                      ]
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-10-01-preview",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('privateStorageAcctName'))]",
                      "name": "[guid(format('rbac-{0}-adf', parameters('privateStorageAcctName')))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                        "principalId": "[reference(resourceId('Microsoft.DataFactory/factories', replace(variables('baseName'), '{rtype}', 'adf')), '2018-06-01', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DataFactory/factories', replace(variables('baseName'), '{rtype}', 'adf'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2020-10-01",
                      "name": "[format('StopTrigger-{0}', replace(parameters('deploymentNameStructure'), '{rtype}', 'dplscr'))]",
                      "properties": {
                        "expressionEvaluationOptions": {
                          "scope": "inner"
                        },
                        "mode": "Incremental",
                        "parameters": {
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "subwloadname": {
                            "value": "StopTriggers"
                          },
                          "namingStructure": {
                            "value": "[parameters('namingStructure')]"
                          },
                          "arguments": {
                            "value": "[format(' -ResourceGroupName {0} -azureDataFactoryName {1}', resourceGroup().name, replace(variables('baseName'), '{rtype}', 'adf'))]"
                          },
                          "scriptContent": {
                            "value": "\r\n          param(\r\n            [string] [Parameter(Mandatory=$true)] $ResourceGroupName,\r\n            [string] [Parameter(Mandatory=$true)] $azureDataFactoryName\r\n            )\r\n\r\n          Connect-AzAccount -Identity\r\n\r\n          # Stop Triggers\r\n          Get-AzDataFactoryV2Trigger -DataFactoryName $azureDataFactoryName -ResourceGroupName $ResourceGroupName | Where-Object { $_.RuntimeState -eq 'Started' } | Stop-AzDataFactoryV2Trigger -Force | Out-Null\r\n"
                          },
                          "userAssignedIdentityId": {
                            "value": "[parameters('userAssignedIdentityId')]"
                          }
                        },
                        "template": {
                          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                          "contentVersion": "1.0.0.0",
                          "metadata": {
                            "_generator": {
                              "name": "bicep",
                              "version": "0.4.1318.3566",
                              "templateHash": "7299696582743820056"
                            }
                          },
                          "parameters": {
                            "location": {
                              "type": "string"
                            },
                            "namingStructure": {
                              "type": "string"
                            },
                            "subwloadname": {
                              "type": "string",
                              "defaultValue": ""
                            },
                            "arguments": {
                              "type": "string"
                            },
                            "scriptContent": {
                              "type": "string"
                            },
                            "userAssignedIdentityId": {
                              "type": "string"
                            },
                            "tags": {
                              "type": "object",
                              "defaultValue": {}
                            },
                            "currentTime": {
                              "type": "string",
                              "defaultValue": "[utcNow()]"
                            }
                          },
                          "variables": {
                            "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]"
                          },
                          "resources": [
                            {
                              "type": "Microsoft.Resources/deploymentScripts",
                              "apiVersion": "2020-10-01",
                              "name": "[replace(variables('baseName'), '{rtype}', 'dplscr')]",
                              "location": "[parameters('location')]",
                              "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                  "[format('{0}', parameters('userAssignedIdentityId'))]": {}
                                }
                              },
                              "kind": "AzurePowerShell",
                              "properties": {
                                "azPowerShellVersion": "6.4",
                                "timeout": "PT10M",
                                "arguments": "[parameters('arguments')]",
                                "scriptContent": "[parameters('scriptContent')]",
                                "cleanupPreference": "OnSuccess",
                                "retentionInterval": "P1D",
                                "forceUpdateTag": "[parameters('currentTime')]"
                              },
                              "tags": "[parameters('tags')]"
                            }
                          ]
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DataFactory/factories', replace(variables('baseName'), '{rtype}', 'adf'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "principalId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.DataFactory/factories', replace(variables('baseName'), '{rtype}', 'adf')), '2018-06-01', 'full').identity.principalId]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[replace(variables('baseName'), '{rtype}', 'adf')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'uami'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'logicApp')]",
              "resourceGroup": "[parameters('privateStorageAccountRG')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "namingStructure": {
                    "value": "[parameters('namingStructure')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "storageAcctName": {
                    "value": "[parameters('privateStorageAccountName')]"
                  },
                  "adfName": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf'))).outputs.name.value]"
                  },
                  "pipelineName": {
                    "value": "[parameters('pipelineName')]"
                  },
                  "approverEmail": {
                    "value": "[parameters('approverEmail')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "10810513299205939219"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "namingStructure": {
                      "type": "string"
                    },
                    "subwloadname": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "adfName": {
                      "type": "string"
                    },
                    "pipelineName": {
                      "type": "string"
                    },
                    "storageAcctName": {
                      "type": "string"
                    },
                    "approverEmail": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Web/connections",
                      "apiVersion": "2018-07-01-preview",
                      "name": "[format('api-{0}', parameters('adfName'))]",
                      "location": "[parameters('location')]",
                      "kind": "V1",
                      "properties": {
                        "displayName": "[parameters('adfName')]",
                        "api": {
                          "id": "[subscriptionResourceId('Microsoft.Web/locations/managedApis', parameters('location'), 'azuredatafactory')]"
                        },
                        "parameterValueType": "Alternative"
                      },
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Web/connections",
                      "apiVersion": "2018-07-01-preview",
                      "name": "[format('api-{0}', parameters('storageAcctName'))]",
                      "location": "[parameters('location')]",
                      "kind": "V1",
                      "properties": {
                        "displayName": "[parameters('storageAcctName')]",
                        "api": {
                          "id": "[subscriptionResourceId('Microsoft.Web/locations/managedApis', parameters('location'), 'azureblob')]"
                        },
                        "parameterValueSet": {
                          "name": "managedIdentityAuth",
                          "value": {}
                        }
                      },
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Web/connections",
                      "apiVersion": "2018-07-01-preview",
                      "name": "api-office365",
                      "location": "[parameters('location')]",
                      "kind": "V1",
                      "properties": {
                        "displayName": "office365",
                        "api": {
                          "id": "[subscriptionResourceId('Microsoft.Web/locations/managedApis', parameters('location'), 'office365')]"
                        }
                      },
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Logic/workflows",
                      "apiVersion": "2019-05-01",
                      "name": "[replace(variables('baseName'), '{rtype}', 'logicApp')]",
                      "location": "[parameters('location')]",
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "properties": {
                        "definition": "[json('{\r\n  \"$schema\": \"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#\",\r\n  \"contentVersion\": \"1.0.0.0\",\r\n  \"parameters\": {\r\n    \"$connections\": {\r\n      \"defaultValue\": {},\r\n      \"type\": \"Object\"\r\n    },\r\n    \"subscriptionId\": {\r\n      \"defaultValue\": \"\",\r\n      \"type\": \"String\"\r\n    },\r\n    \"dataFactoryRG\": {\r\n      \"defaultValue\": \"\",\r\n      \"type\": \"String\"\r\n    },\r\n    \"dataFactoryName\": {\r\n      \"defaultValue\": \"\",\r\n      \"type\": \"String\"\r\n    },\r\n    \"pipelineName\": {\r\n      \"defaultValue\": \"\",\r\n      \"type\": \"String\"\r\n    },\r\n    \"storageAccountName\": {\r\n      \"defaultValue\": \"\",\r\n      \"type\": \"String\"\r\n    },\r\n    \"approverEmail\": {\r\n      \"defaultValue\": \"\",\r\n      \"type\": \"String\"\r\n    }\r\n  },\r\n  \"triggers\": {\r\n    \"When_a_blob_is_added_or_modified_(properties_only)_(V2)\": {\r\n      \"evaluatedRecurrence\": {\r\n        \"frequency\": \"Minute\",\r\n        \"interval\": 1\r\n      },\r\n      \"inputs\": {\r\n        \"host\": {\r\n          \"connection\": {\r\n            \"name\": \"@parameters(''$connections'')[''azureblob''][''connectionId'']\"\r\n          }\r\n        },\r\n        \"method\": \"get\",\r\n        \"path\": \"/v2/datasets/@{parameters(''storageAccountName'')}/triggers/batch/onupdatedfile\",\r\n        \"queries\": {\r\n          \"checkBothCreatedAndModifiedDateTime\": false,\r\n          \"folderId\": \"/export-pending\",\r\n          \"maxFileCount\": 1\r\n        }\r\n      },\r\n      \"recurrence\": {\r\n        \"frequency\": \"Minute\",\r\n        \"interval\": 1\r\n      },\r\n      \"splitOn\": \"@triggerBody()\",\r\n      \"type\": \"ApiConnection\"\r\n    }\r\n  },\r\n  \"actions\": {\r\n    \"Condition\": {\r\n      \"actions\": {\r\n        \"Create_a_pipeline_run\": {\r\n          \"inputs\": {\r\n            \"body\": {\r\n              \"fileName\": \"@triggerBody()?[''Name'']\",\r\n              \"sinkFolderPath\": \"export-approved\",\r\n              \"sinkStorageAccountName\": \"@parameters(''storageAccountName'')\",\r\n              \"sourceFolderPath\": \"export-pending\",\r\n              \"sourceStorageAccountName\": \"@parameters(''storageAccountName'')\"\r\n            },\r\n            \"host\": {\r\n              \"connection\": {\r\n                \"name\": \"@parameters(''$connections'')[''azuredatafactory''][''connectionId'']\"\r\n              }\r\n            },\r\n            \"method\": \"post\",\r\n            \"path\": \"/subscriptions/@{parameters(''subscriptionId'')}/resourcegroups/@{parameters(''dataFactoryRG'')}/providers/Microsoft.DataFactory/factories/@{parameters(''dataFactoryName'')}/pipelines/@{parameters(''pipelineName'')}/CreateRun\",\r\n            \"queries\": {\r\n              \"x-ms-api-version\": \"2017-09-01-preview\"\r\n            }\r\n          },\r\n          \"runAfter\": {},\r\n          \"type\": \"ApiConnection\"\r\n        }\r\n      },\r\n      \"expression\": {\r\n        \"and\": [\r\n          {\r\n            \"equals\": [\r\n              \"@body(''Send_approval_email'')?[''SelectedOption'']\",\r\n              \"Approve\"\r\n            ]\r\n          }\r\n        ]\r\n      },\r\n      \"runAfter\": {\r\n        \"Send_approval_email\": [\"Succeeded\"]\r\n      },\r\n      \"type\": \"If\"\r\n    },\r\n    \"Send_approval_email\": {\r\n      \"inputs\": {\r\n        \"body\": {\r\n          \"Message\": {\r\n            \"HideHTMLMessage\": false,\r\n            \"Importance\": \"Normal\",\r\n            \"Options\": \"Approve, Reject\",\r\n            \"ShowHTMLConfirmationDialog\": false,\r\n            \"Subject\": \"Approval Request\",\r\n            \"To\": \"@parameters(''approverEmail'')\"\r\n          },\r\n          \"NotificationUrl\": \"@{listCallbackUrl()}\"\r\n        },\r\n        \"host\": {\r\n          \"connection\": {\r\n            \"name\": \"@parameters(''$connections'')[''office365''][''connectionId'']\"\r\n          }\r\n        },\r\n        \"path\": \"/approvalmail/$subscriptions\"\r\n      },\r\n      \"runAfter\": {},\r\n      \"type\": \"ApiConnectionWebhook\"\r\n    }\r\n  },\r\n  \"outputs\": {}\r\n}\r\n')]",
                        "parameters": {
                          "$connections": {
                            "value": {
                              "azureblob": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', format('api-{0}', parameters('storageAcctName')))]",
                                "connectionName": "azureblob",
                                "connectionProperties": {
                                  "authentication": {
                                    "type": "ManagedServiceIdentity"
                                  }
                                },
                                "id": "[subscriptionResourceId('Microsoft.Web/locations/managedApis', parameters('location'), 'azureblob')]"
                              },
                              "azuredatafactory": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', format('api-{0}', parameters('adfName')))]",
                                "connectionName": "azuredatafactory",
                                "connectionProperties": {
                                  "authentication": {
                                    "type": "ManagedServiceIdentity"
                                  }
                                },
                                "id": "[subscriptionResourceId('Microsoft.Web/locations/managedApis', parameters('location'), 'azuredatafactory')]"
                              },
                              "office365": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', 'api-office365')]",
                                "connectionName": "office365",
                                "id": "[subscriptionResourceId('Microsoft.Web/locations/managedApis', parameters('location'), 'office365')]"
                              }
                            }
                          },
                          "subscriptionId": {
                            "value": "[subscription().subscriptionId]"
                          },
                          "dataFactoryRG": {
                            "value": "[resourceGroup().name]"
                          },
                          "dataFactoryName": {
                            "value": "[parameters('adfName')]"
                          },
                          "pipelineName": {
                            "value": "[parameters('pipelineName')]"
                          },
                          "storageAccountName": {
                            "value": "[parameters('storageAcctName')]"
                          },
                          "approverEmail": {
                            "value": "[parameters('approverEmail')]"
                          }
                        }
                      },
                      "tags": "[parameters('tags')]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Web/connections', format('api-{0}', parameters('adfName')))]",
                        "[resourceId('Microsoft.Web/connections', 'api-office365')]",
                        "[resourceId('Microsoft.Web/connections', format('api-{0}', parameters('storageAcctName')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-10-01-preview",
                      "scope": "[format('Microsoft.DataFactory/factories/{0}', parameters('adfName'))]",
                      "name": "[guid(format('rbac-{0}-adf', parameters('adfName')))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '673868aa-7521-48a0-acc6-0f60742d39f5')]",
                        "principalId": "[reference(resourceId('Microsoft.Logic/workflows', replace(variables('baseName'), '{rtype}', 'logicApp')), '2019-05-01', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Logic/workflows', replace(variables('baseName'), '{rtype}', 'logicApp'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-10-01-preview",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAcctName'))]",
                      "name": "[guid(format('rbac-{0}-logicapp', parameters('storageAcctName')))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                        "principalId": "[reference(resourceId('Microsoft.Logic/workflows', replace(variables('baseName'), '{rtype}', 'logicApp')), '2019-05-01', 'full').identity.principalId]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Logic/workflows', replace(variables('baseName'), '{rtype}', 'logicApp'))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'stg-pub')]",
              "resourceGroup": "[parameters('privateStorageAccountRG')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "namingStructure": {
                    "value": "[parameters('namingStructure')]"
                  },
                  "subwloadname": {
                    "value": "pub"
                  },
                  "containerNames": {
                    "value": [
                      "[parameters('containerNames').ingestContainerName]"
                    ]
                  },
                  "principalIds": {
                    "value": [
                      "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf'))).outputs.principalId.value]"
                    ]
                  },
                  "privatize": {
                    "value": false
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "14962272343539166207"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "namingStructure": {
                      "type": "string"
                    },
                    "subwloadname": {
                      "type": "string"
                    },
                    "containerNames": {
                      "type": "array"
                    },
                    "skuName": {
                      "type": "string",
                      "defaultValue": "Standard_LRS"
                    },
                    "privatize": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "vnetId": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "subnetId": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "principalIds": {
                      "type": "array",
                      "defaultValue": []
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "assignRole": "[not(empty(parameters('principalIds')))]",
                    "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]",
                    "stgNameClean": "[take(replace(guid(subscription().id, resourceGroup().id, variables('baseName')), '-', ''), 22)]",
                    "endpoint": "[format('privatelink.blob.{0}', environment().suffixes.storage)]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2021-06-01",
                      "name": "[format('st{0}', variables('stgNameClean'))]",
                      "location": "[parameters('location')]",
                      "kind": "StorageV2",
                      "sku": {
                        "name": "[parameters('skuName')]"
                      },
                      "properties": {
                        "minimumTlsVersion": "TLS1_2",
                        "allowBlobPublicAccess": false,
                        "isHnsEnabled": true,
                        "supportsHttpsTrafficOnly": true,
                        "accessTier": "Hot",
                        "networkAcls": {
                          "bypass": "AzureServices",
                          "defaultAction": "[if(parameters('privatize'), 'Deny', 'Allow')]"
                        },
                        "publicNetworkAccess": "[if(parameters('privatize'), 'Disabled', 'Enabled')]"
                      },
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Storage/storageAccounts/blobServices",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}', format('st{0}', variables('stgNameClean')), 'default')]",
                      "properties": {
                        "containerDeleteRetentionPolicy": {
                          "enabled": true,
                          "days": 7
                        },
                        "deleteRetentionPolicy": {
                          "enabled": false
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', format('st{0}', variables('stgNameClean')))]"
                      ]
                    },
                    {
                      "copy": {
                        "name": "container",
                        "count": "[length(parameters('containerNames'))]"
                      },
                      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                      "apiVersion": "2021-06-01",
                      "name": "[format('{0}/{1}/{2}', format('st{0}', variables('stgNameClean')), 'default', parameters('containerNames')[copyIndex()])]",
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', format('st{0}', variables('stgNameClean')), 'default')]",
                        "[resourceId('Microsoft.Storage/storageAccounts', format('st{0}', variables('stgNameClean')))]"
                      ]
                    },
                    {
                      "condition": "[parameters('privatize')]",
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-03-01",
                      "name": "[replace(variables('baseName'), '{rtype}', 'pep')]",
                      "location": "[parameters('location')]",
                      "tags": {},
                      "properties": {
                        "subnet": {
                          "id": "[parameters('subnetId')]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[replace(variables('baseName'), '{rtype}', 'pep')]",
                            "properties": {
                              "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', format('st{0}', variables('stgNameClean')))]",
                              "groupIds": [
                                "blob"
                              ]
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', format('st{0}', variables('stgNameClean')))]"
                      ]
                    },
                    {
                      "condition": "[parameters('privatize')]",
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2018-09-01",
                      "name": "[variables('endpoint')]",
                      "location": "global",
                      "properties": {},
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "condition": "[parameters('privatize')]",
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}/default', replace(variables('baseName'), '{rtype}', 'pep'))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "privatelink-blob-core-windows-net",
                            "properties": {
                              "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('endpoint'))]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateEndpoints', replace(variables('baseName'), '{rtype}', 'pep'))]",
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('endpoint'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('privatize')]",
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2018-09-01",
                      "name": "[format('{0}/{1}', variables('endpoint'), uniqueString(parameters('vnetId')))]",
                      "location": "global",
                      "properties": {
                        "virtualNetwork": {
                          "id": "[parameters('vnetId')]"
                        },
                        "registrationEnabled": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', variables('endpoint'))]"
                      ]
                    },
                    {
                      "condition": "[variables('assignRole')]",
                      "copy": {
                        "name": "rbacAssignment",
                        "count": "[length(parameters('principalIds'))]"
                      },
                      "type": "Microsoft.Authorization/roleAssignments",
                      "apiVersion": "2020-10-01-preview",
                      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', format('st{0}', variables('stgNameClean')))]",
                      "name": "[guid(format('rbac-{0}-{1}', format('st{0}', variables('stgNameClean')), parameters('principalIds')[copyIndex()]))]",
                      "properties": {
                        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
                        "principalId": "[parameters('principalIds')[copyIndex()]]",
                        "principalType": "ServicePrincipal"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', format('st{0}', variables('stgNameClean')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "storageAccountId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Storage/storageAccounts', format('st{0}', variables('stgNameClean')))]"
                    },
                    "storageAccountName": {
                      "type": "string",
                      "value": "[format('st{0}', variables('stgNameClean'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'evgt-public')]",
              "resourceGroup": "[parameters('privateStorageAccountRG')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "namingStructure": {
                    "value": "[parameters('namingStructure')]"
                  },
                  "subwloadname": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'stg-pub'))).outputs.storageAccountName.value]"
                  },
                  "resourceId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'stg-pub'))).outputs.storageAccountId.value]"
                  },
                  "topicName": {
                    "value": "Microsoft.Storage.StorageAccounts"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "5872599097049968124"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "namingStructure": {
                      "type": "string"
                    },
                    "subwloadname": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "resourceId": {
                      "type": "string"
                    },
                    "topicName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.EventGrid/systemTopics",
                      "apiVersion": "2021-06-01-preview",
                      "name": "[replace(variables('baseName'), '{rtype}', 'evgt')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "source": "[parameters('resourceId')]",
                        "topicType": "[parameters('topicName')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "systemTopicName": {
                      "type": "string",
                      "value": "[replace(variables('baseName'), '{rtype}', 'evgt')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'stg-pub'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'evgt-private')]",
              "resourceGroup": "[parameters('privateStorageAccountRG')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "namingStructure": {
                    "value": "[parameters('namingStructure')]"
                  },
                  "subwloadname": {
                    "value": "[parameters('privateStorageAccountName')]"
                  },
                  "resourceId": {
                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Storage/storageAccounts', parameters('privateStorageAccountName'))]"
                  },
                  "topicName": {
                    "value": "Microsoft.Storage.StorageAccounts"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "5872599097049968124"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "namingStructure": {
                      "type": "string"
                    },
                    "subwloadname": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "resourceId": {
                      "type": "string"
                    },
                    "topicName": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.EventGrid/systemTopics",
                      "apiVersion": "2021-06-01-preview",
                      "name": "[replace(variables('baseName'), '{rtype}', 'evgt')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "source": "[parameters('resourceId')]",
                        "topicType": "[parameters('topicName')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ],
                  "outputs": {
                    "systemTopicName": {
                      "type": "string",
                      "value": "[replace(variables('baseName'), '{rtype}', 'evgt')]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'adf-trigger-public')]",
              "resourceGroup": "[parameters('privateStorageAccountRG')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "adfName": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf'))).outputs.name.value]"
                  },
                  "workspaceName": {
                    "value": "[parameters('workspaceName')]"
                  },
                  "storageAccountId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'stg-pub'))).outputs.storageAccountId.value]"
                  },
                  "storageAccountType": {
                    "value": "Public"
                  },
                  "ingestPipelineName": {
                    "value": "[parameters('pipelineName')]"
                  },
                  "sourceStorageAccountName": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'stg-pub'))).outputs.storageAccountName.value]"
                  },
                  "sinkStorageAccountName": {
                    "value": "[parameters('privateStorageAccountName')]"
                  },
                  "containerName": {
                    "value": "[parameters('containerNames').ingestContainerName]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "9806826452630078105"
                    }
                  },
                  "parameters": {
                    "storageAccountId": {
                      "type": "string"
                    },
                    "sinkStorageAccountName": {
                      "type": "string"
                    },
                    "sourceStorageAccountName": {
                      "type": "string"
                    },
                    "adfName": {
                      "type": "string"
                    },
                    "ingestPipelineName": {
                      "type": "string"
                    },
                    "workspaceName": {
                      "type": "string"
                    },
                    "storageAccountType": {
                      "type": "string",
                      "allowedValues": [
                        "Public",
                        "Private"
                      ]
                    },
                    "containerName": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.DataFactory/factories/triggers",
                      "apiVersion": "2018-06-01",
                      "name": "[format('{0}/trigger_ws_{1}_{2}_BlobCreated', parameters('adfName'), parameters('workspaceName'), parameters('storageAccountType'))]",
                      "properties": {
                        "type": "BlobEventsTrigger",
                        "typeProperties": {
                          "blobPathBeginsWith": "[if(not(empty(parameters('containerName'))), format('/{0}/blobs/', parameters('containerName')), json('null'))]",
                          "ignoreEmptyBlobs": true,
                          "events": [
                            "Microsoft.Storage.BlobCreated"
                          ],
                          "scope": "[parameters('storageAccountId')]"
                        },
                        "pipelines": [
                          {
                            "pipelineReference": {
                              "referenceName": "[parameters('ingestPipelineName')]",
                              "type": "PipelineReference"
                            },
                            "parameters": {
                              "sourceStorageAccountName": "[parameters('sourceStorageAccountName')]",
                              "sinkStorageAccountName": "[parameters('sinkStorageAccountName')]",
                              "fileName": "@triggerBody().fileName",
                              "sourceFolderPath": "@triggerBody().folderPath",
                              "sinkFolderPath": "@triggerBody().folderPath"
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'stg-pub'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'adf-trigger-private')]",
              "resourceGroup": "[parameters('privateStorageAccountRG')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "adfName": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf'))).outputs.name.value]"
                  },
                  "workspaceName": {
                    "value": "[parameters('workspaceName')]"
                  },
                  "storageAccountId": {
                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Storage/storageAccounts', parameters('privateStorageAccountName'))]"
                  },
                  "storageAccountType": {
                    "value": "Private"
                  },
                  "ingestPipelineName": {
                    "value": "[parameters('pipelineName')]"
                  },
                  "sourceStorageAccountName": {
                    "value": "[parameters('privateStorageAccountName')]"
                  },
                  "sinkStorageAccountName": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'stg-pub'))).outputs.storageAccountName.value]"
                  },
                  "containerName": {
                    "value": "[parameters('containerNames').exportApprovedContainerName]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "9806826452630078105"
                    }
                  },
                  "parameters": {
                    "storageAccountId": {
                      "type": "string"
                    },
                    "sinkStorageAccountName": {
                      "type": "string"
                    },
                    "sourceStorageAccountName": {
                      "type": "string"
                    },
                    "adfName": {
                      "type": "string"
                    },
                    "ingestPipelineName": {
                      "type": "string"
                    },
                    "workspaceName": {
                      "type": "string"
                    },
                    "storageAccountType": {
                      "type": "string",
                      "allowedValues": [
                        "Public",
                        "Private"
                      ]
                    },
                    "containerName": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.DataFactory/factories/triggers",
                      "apiVersion": "2018-06-01",
                      "name": "[format('{0}/trigger_ws_{1}_{2}_BlobCreated', parameters('adfName'), parameters('workspaceName'), parameters('storageAccountType'))]",
                      "properties": {
                        "type": "BlobEventsTrigger",
                        "typeProperties": {
                          "blobPathBeginsWith": "[if(not(empty(parameters('containerName'))), format('/{0}/blobs/', parameters('containerName')), json('null'))]",
                          "ignoreEmptyBlobs": true,
                          "events": [
                            "Microsoft.Storage.BlobCreated"
                          ],
                          "scope": "[parameters('storageAccountId')]"
                        },
                        "pipelines": [
                          {
                            "pipelineReference": {
                              "referenceName": "[parameters('ingestPipelineName')]",
                              "type": "PipelineReference"
                            },
                            "parameters": {
                              "sourceStorageAccountName": "[parameters('sourceStorageAccountName')]",
                              "sinkStorageAccountName": "[parameters('sinkStorageAccountName')]",
                              "fileName": "@triggerBody().fileName",
                              "sourceFolderPath": "@triggerBody().folderPath",
                              "sinkFolderPath": "@triggerBody().folderPath"
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'stg-pub'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'adf-pep')]",
              "resourceGroup": "[parameters('privateStorageAccountRG')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "adfName": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf'))).outputs.name.value]"
                  },
                  "privateStorageAccountId": {
                    "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Storage/storageAccounts', parameters('privateStorageAccountName'))]"
                  },
                  "privateStorageAccountName": {
                    "value": "[parameters('privateStorageAccountName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "10083270956540796732"
                    }
                  },
                  "parameters": {
                    "adfName": {
                      "type": "string"
                    },
                    "privateStorageAccountId": {
                      "type": "string"
                    },
                    "privateStorageAccountName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.DataFactory/factories/managedVirtualNetworks/managedPrivateEndpoints",
                      "apiVersion": "2018-06-01",
                      "name": "[format('{0}/default/pe-{1}-dfs', parameters('adfName'), parameters('privateStorageAccountName'))]",
                      "properties": {
                        "privateLinkResourceId": "[parameters('privateStorageAccountId')]",
                        "groupId": "dfs"
                      }
                    }
                  ],
                  "outputs": {
                    "privateEndpointId": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.DataFactory/factories/managedVirtualNetworks/managedPrivateEndpoints', split(format('{0}/default/pe-{1}-dfs', parameters('adfName'), parameters('privateStorageAccountName')), '/')[0], split(format('{0}/default/pe-{1}-dfs', parameters('adfName'), parameters('privateStorageAccountName')), '/')[1], split(format('{0}/default/pe-{1}-dfs', parameters('adfName'), parameters('privateStorageAccountName')), '/')[2])).privateLinkResourceId]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('StartTrigger-{0}', replace(parameters('deploymentNameStructure'), '{rtype}', 'dplscr'))]",
              "resourceGroup": "[parameters('privateStorageAccountRG')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "subwloadname": {
                    "value": "StartTriggers"
                  },
                  "namingStructure": {
                    "value": "[parameters('namingStructure')]"
                  },
                  "arguments": {
                    "value": "[format(' -ResourceGroupName {0} -azureDataFactoryName {1} -privateLinkResourceId {2}', parameters('privateStorageAccountRG'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf'))).outputs.name.value, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf-pep'))).outputs.privateEndpointId.value)]"
                  },
                  "scriptContent": {
                    "value": "\r\n          param(\r\n            [string] [Parameter(Mandatory=$true)] $ResourceGroupName,\r\n            [string] [Parameter(Mandatory=$true)] $azureDataFactoryName,\r\n            [string] [Parameter(Mandatory=$true)] $privateLinkResourceId\r\n          )\r\n\r\n          Connect-AzAccount -Identity\r\n\r\n          # Start Triggers\r\n          Get-AzDataFactoryV2Trigger -DataFactoryName $azureDataFactoryName -ResourceGroupName $ResourceGroupName | Start-AzDataFactoryV2Trigger -Force | Out-Null\r\n\r\n          # Approve DFS private endpoint\r\n          foreach ($privateLinkConnection in (Get-AzPrivateEndpointConnection -PrivateLinkResourceId $privateLinkResourceId)) { if ($privateLinkConnection.PrivateLinkServiceConnectionState.Status -eq \"Pending\") { Approve-AzPrivateEndpointConnection -ResourceId $privateLinkConnection.id } }\r\n        "
                  },
                  "userAssignedIdentityId": {
                    "value": "[if(not(empty(parameters('userAssignedManagedIdentity'))), parameters('userAssignedManagedIdentity').id, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'uami')), '2020-10-01').outputs.managedIdentityId.value)]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "7299696582743820056"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "namingStructure": {
                      "type": "string"
                    },
                    "subwloadname": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "arguments": {
                      "type": "string"
                    },
                    "scriptContent": {
                      "type": "string"
                    },
                    "userAssignedIdentityId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    },
                    "currentTime": {
                      "type": "string",
                      "defaultValue": "[utcNow()]"
                    }
                  },
                  "variables": {
                    "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Resources/deploymentScripts",
                      "apiVersion": "2020-10-01",
                      "name": "[replace(variables('baseName'), '{rtype}', 'dplscr')]",
                      "location": "[parameters('location')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('userAssignedIdentityId'))]": {}
                        }
                      },
                      "kind": "AzurePowerShell",
                      "properties": {
                        "azPowerShellVersion": "6.4",
                        "timeout": "PT10M",
                        "arguments": "[parameters('arguments')]",
                        "scriptContent": "[parameters('scriptContent')]",
                        "cleanupPreference": "OnSuccess",
                        "retentionInterval": "P1D",
                        "forceUpdateTag": "[parameters('currentTime')]"
                      },
                      "tags": "[parameters('tags')]"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'adf-pep'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('privateStorageAccountRG')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'uami'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', replace(replace(variables('namingStructure'), '{subwloadname}', 'storage'), '{rtype}', 'rg'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(replace(variables('namingStructure'), '{subwloadname}', 'storage'), '{rtype}', 'rg')), 'Microsoft.Resources/deployments', replace(variables('deploymentNameStructure'), '{rtype}', 'stg-pri'))]"
      ]
    },
    {
      "condition": "[parameters('avdAccess')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('access-{0}', parameters('deploymentTime'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "namingStructure": {
            "value": "[variables('namingStructure')]"
          },
          "subwloadname": {
            "value": "access"
          },
          "deploymentNameStructure": {
            "value": "[variables('deploymentNameStructure')]"
          },
          "vmCount": {
            "value": "[parameters('vmCount')]"
          },
          "rdshVmSize": {
            "value": "[parameters('rdshVmSize')]"
          },
          "avdSubnetId": {
            "value": "[if(empty(parameters('virtualNetwork')), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(replace(variables('namingStructure'), '{subwloadname}', 'network'), '{rtype}', 'rg')), 'Microsoft.Resources/deployments', replace(variables('deploymentNameStructure'), '{rtype}', 'net')), '2020-10-01').outputs.workloadSubnetId.value, parameters('computeSubnetId'))]"
          },
          "rdshPrefix": {
            "value": "rdsh"
          },
          "tags": {
            "value": "[parameters('tags').All_Resources]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.4.1318.3566",
              "templateHash": "4979982869028689892"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "namingStructure": {
              "type": "string"
            },
            "subwloadname": {
              "type": "string",
              "defaultValue": ""
            },
            "deploymentNameStructure": {
              "type": "string"
            },
            "avdSubnetId": {
              "type": "string"
            },
            "rdshVmSize": {
              "type": "string"
            },
            "rdshPrefix": {
              "type": "string"
            },
            "vmCount": {
              "type": "int"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "variables": {
            "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-04-01",
              "name": "[replace(variables('baseName'), '{rtype}', 'rg')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'avd')]",
              "resourceGroup": "[replace(variables('baseName'), '{rtype}', 'rg')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "namingStructure": {
                    "value": "[parameters('namingStructure')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "11598349481684982477"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "environment": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "namingStructure": {
                      "type": "string"
                    },
                    "subwloadname": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "baseTime": {
                      "type": "string",
                      "defaultValue": "[utcNow('u')]"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "baseName": "[if(not(empty(parameters('subwloadname'))), replace(parameters('namingStructure'), '{subwloadname}', parameters('subwloadname')), replace(parameters('namingStructure'), '-{subwloadname}', ''))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.DesktopVirtualization/hostPools",
                      "apiVersion": "2021-09-03-preview",
                      "name": "[replace(variables('baseName'), '{rtype}', 'hp')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "hostPoolType": "Pooled",
                        "loadBalancerType": "BreadthFirst",
                        "preferredAppGroupType": "RailApplications",
                        "customRdpProperty": "drivestoredirect:s:0;audiomode:i:0;videoplaybackmode:i:1;redirectclipboard:i:0;redirectprinters:i:0;devicestoredirect:s:0;redirectcomports:i:0;redirectsmartcards:i:1;usbdevicestoredirect:s:0;enablecredsspsupport:i:1;use multimon:i:1;targetisaadjoined:i:1;",
                        "friendlyName": "[format('{0} Research Enclave Access', parameters('environment'))]",
                        "startVMOnConnect": true,
                        "registrationInfo": {
                          "registrationTokenOperation": "Update",
                          "expirationTime": "[dateTimeAdd(parameters('baseTime'), 'P2D')]"
                        }
                      },
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.DesktopVirtualization/applicationGroups",
                      "apiVersion": "2021-09-03-preview",
                      "name": "[replace(variables('baseName'), '{rtype}', 'ag')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "hostPoolArmPath": "[resourceId('Microsoft.DesktopVirtualization/hostPools', replace(variables('baseName'), '{rtype}', 'hp'))]",
                        "applicationGroupType": "RemoteApp"
                      },
                      "tags": "[parameters('tags')]",
                      "dependsOn": [
                        "[resourceId('Microsoft.DesktopVirtualization/hostPools', replace(variables('baseName'), '{rtype}', 'hp'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.DesktopVirtualization/applicationGroups/applications",
                      "apiVersion": "2021-09-03-preview",
                      "name": "[format('{0}/{1}', replace(variables('baseName'), '{rtype}', 'ag'), 'Remote Desktop')]",
                      "properties": {
                        "commandLineSetting": "DoNotAllow",
                        "applicationType": "InBuilt",
                        "friendlyName": "Remote Desktop",
                        "filePath": "C:\\Windows\\System32\\mstsc.exe",
                        "iconPath": "C:\\Windows\\System32\\mstsc.exe",
                        "iconIndex": 0,
                        "showInPortal": true
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', replace(variables('baseName'), '{rtype}', 'ag'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.DesktopVirtualization/workspaces",
                      "apiVersion": "2021-09-03-preview",
                      "name": "[replace(variables('baseName'), '{rtype}', 'ws')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "friendlyName": "Research Enclave Access",
                        "applicationGroupReferences": [
                          "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', replace(variables('baseName'), '{rtype}', 'ag'))]"
                        ]
                      },
                      "tags": "[parameters('tags')]",
                      "dependsOn": [
                        "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', replace(variables('baseName'), '{rtype}', 'ag'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "hostpoolRegistrationToken": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.DesktopVirtualization/hostPools', replace(variables('baseName'), '{rtype}', 'hp'))).registrationInfo.token]"
                    },
                    "hostpoolName": {
                      "type": "string",
                      "value": "[replace(variables('baseName'), '{rtype}', 'hp')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', replace(variables('baseName'), '{rtype}', 'rg'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'avdvm-vms')]",
              "resourceGroup": "[replace(variables('baseName'), '{rtype}', 'rg')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "hostPoolRegistrationToken": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('baseName'), '{rtype}', 'rg')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'avd'))).outputs.hostpoolRegistrationToken.value]"
                  },
                  "deploymentNameStructure": {
                    "value": "[parameters('deploymentNameStructure')]"
                  },
                  "vmCount": {
                    "value": "[parameters('vmCount')]"
                  },
                  "rdshVmSize": {
                    "value": "[parameters('rdshVmSize')]"
                  },
                  "rdshPrefix": {
                    "value": "[parameters('rdshPrefix')]"
                  },
                  "hostPoolName": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('baseName'), '{rtype}', 'rg')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'avd'))).outputs.hostpoolName.value]"
                  },
                  "avdSubnetId": {
                    "value": "[parameters('avdSubnetId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.4.1318.3566",
                      "templateHash": "15834731645588540393"
                    }
                  },
                  "parameters": {
                    "location": {
                      "type": "string"
                    },
                    "rdshPrefix": {
                      "type": "string"
                    },
                    "avdSubnetId": {
                      "type": "string"
                    },
                    "rdshVmSize": {
                      "type": "string"
                    },
                    "hostPoolRegistrationToken": {
                      "type": "string"
                    },
                    "hostPoolName": {
                      "type": "string"
                    },
                    "vmCount": {
                      "type": "int",
                      "defaultValue": 1
                    },
                    "deploymentNameStructure": {
                      "type": "string",
                      "defaultValue": "[format('{{rtype}}-{0}', utcNow())]"
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {}
                    }
                  },
                  "variables": {
                    "nestedTemplatesLocation": "[format('https://wvdportalstorageblob.blob.{0}/galleryartifacts/armtemplates/Hostpool_12-9-2021/nestedTemplates/', environment().suffixes.storage)]",
                    "vmTemplateUri": "[format('{0}managedDisks-galleryvm.json', variables('nestedTemplatesLocation'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/availabilitySets",
                      "apiVersion": "2021-11-01",
                      "name": "[format('{0}-avail', parameters('rdshPrefix'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "platformFaultDomainCount": 2,
                        "platformUpdateDomainCount": 5
                      },
                      "sku": {
                        "name": "Aligned"
                      },
                      "tags": "[parameters('tags')]"
                    },
                    {
                      "type": "Microsoft.Resources/deployments",
                      "apiVersion": "2021-04-01",
                      "name": "[replace(parameters('deploymentNameStructure'), '{rtype}', 'avdvm')]",
                      "properties": {
                        "mode": "Incremental",
                        "templateLink": {
                          "uri": "[variables('vmTemplateUri')]",
                          "contentVersion": "1.0.0.0"
                        },
                        "parameters": {
                          "artifactsLocation": {
                            "value": "[format('https://wvdportalstorageblob.blob.{0}/galleryartifacts/Configuration_02-23-2022.zip', environment().suffixes.storage)]"
                          },
                          "availabilityOption": {
                            "value": "AvailabilitySet"
                          },
                          "availabilitySetName": {
                            "value": "[format('{0}-avail', parameters('rdshPrefix'))]"
                          },
                          "vmGalleryImageOffer": {
                            "value": "office-365"
                          },
                          "vmGalleryImagePublisher": {
                            "value": "microsoftwindowsdesktop"
                          },
                          "vmGalleryImageHasPlan": {
                            "value": false
                          },
                          "vmGalleryImageSKU": {
                            "value": "win11-21h2-avd-m365"
                          },
                          "rdshPrefix": {
                            "value": "[parameters('rdshPrefix')]"
                          },
                          "rdshNumberOfInstances": {
                            "value": "[parameters('vmCount')]"
                          },
                          "rdshVMDiskType": {
                            "value": "StandardSSD_LRS"
                          },
                          "rdshVmSize": {
                            "value": "[parameters('rdshVmSize')]"
                          },
                          "enableAcceleratedNetworking": {
                            "value": true
                          },
                          "vmAdministratorAccountUsername": {
                            "value": "AzureUser"
                          },
                          "vmAdministratorAccountPassword": {
                            "value": "Test1234"
                          },
                          "administratorAccountUsername": {
                            "value": ""
                          },
                          "administratorAccountPassword": {
                            "value": ""
                          },
                          "subnet-id": {
                            "value": "[parameters('avdSubnetId')]"
                          },
                          "vhds": {
                            "value": "[format('vhds/{0}', parameters('rdshPrefix'))]"
                          },
                          "location": {
                            "value": "[parameters('location')]"
                          },
                          "createNetworkSecurityGroup": {
                            "value": false
                          },
                          "vmInitialNumber": {
                            "value": 0
                          },
                          "hostpoolName": {
                            "value": "[parameters('hostPoolName')]"
                          },
                          "hostpoolToken": {
                            "value": "[parameters('hostPoolRegistrationToken')]"
                          },
                          "aadJoin": {
                            "value": true
                          },
                          "intune": {
                            "value": false
                          },
                          "securityType": {
                            "value": "TrustedLaunch"
                          },
                          "secureBoot": {
                            "value": true
                          },
                          "vTPM": {
                            "value": true
                          },
                          "vmImageVhdUri": {
                            "value": ""
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/availabilitySets', format('{0}-avail', parameters('rdshPrefix')))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(variables('baseName'), '{rtype}', 'rg')), 'Microsoft.Resources/deployments', replace(parameters('deploymentNameStructure'), '{rtype}', 'avd'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', replace(variables('baseName'), '{rtype}', 'rg'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, replace(replace(variables('namingStructure'), '{subwloadname}', 'network'), '{rtype}', 'rg')), 'Microsoft.Resources/deployments', replace(variables('deploymentNameStructure'), '{rtype}', 'net'))]"
      ]
    }
  ]
}